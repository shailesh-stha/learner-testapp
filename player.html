<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>German Lesson Player</title>
    <link rel="stylesheet" href="style.css">
</head>
<body id="page-player">

    <header>
        <h1><a href="index.html">German Learning Library</a></h1>
    </header>

    <div class="container">
        <a href="index.html">&larr; Back to Lesson List</a>
        
        <div id="player-wrapper">
            <audio id="audio-player"></audio>
            
            <div class="custom-player-controls" id="custom-controls">
                <div id="audio-loader" class="loader" style="display: none;"></div>
                
                <button id="play-pause-btn" aria-label="Play">
                    <svg id="icon-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
                    <svg id="icon-pause" viewBox="0 0 24 24" style="display:none;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>
                </button>
                
                <span id="current-time-display">0:00</span>
                
                <div id="progress-bar-wrapper">
                    <div id="progress-bar-fill"></div>
                </div>
                
                <span id="total-time-display">0:00</span>
            </div>
        </div>
        
        <div class="controls-bar">
            
            <button id="loop-btn" class="control-btn">Loop Line</button>
            
            <button id="toggle-translation" class="control-btn">Hide Translations</button>
            
            <div class="speed-control">
                <label for="playback-speed">Speed:</label>
                <select id="playback-speed">
                    <option value="0.85">0.85x</option>
                    <option value="0.90">0.90x</option>
                    <option value="0.95">0.95x</option>
                    <option value="1.00" selected>1.00x (Normal)</option>
                    <option value="1.05">1.05x</option>
                    <option value="1.10">1.10x</option>
                    <option value="1.15">1.15x</option>
                </select>
            </div>

            <div id="view-mode-controls" class="control-btn-group">
                <button id="view-mode-standard" class="view-mode-btn active" title="Standard View (German + English)">Standard</button>
                <button id="view-mode-german" class="view-mode-btn" title="Immersion View (German Only)">German</button>
                <button id="view-mode-english" class="view-mode-btn" title="Listening View (English Only)">English</button>
            </div>
        </div>
        
        <div id="transcript-container" class="transcript-container view-standard">
            <p>Loading transcript...</p>
        </div>
    </div>

    <script>
        // Store all transcript data globally after fetch
        let transcriptData = []; 
        let currentLineIndex = -1;
        
        // --- NEW: Recommendation 4 (Loop State) ---
        let isLooping = false;

        // --- New helper to format time as MM:SS ---
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
        }

        // Function to load JSON transcript and populate the display
        async function loadTranscript(lessonId) {
            const transcriptContainer = document.getElementById('transcript-container');
            const transcriptUrl = `transcript_${lessonId}.json`;

            try {
                const response = await fetch(transcriptUrl);
                if (!response.ok) { throw new Error('Transcript JSON file not found or invalid.'); }
                transcriptData = await response.json();

                transcriptContainer.innerHTML = ''; 
                
                transcriptData.forEach((line, index) => {
                    const p = document.createElement('p');
                    
                    p.setAttribute('data-index', index); 
                    p.setAttribute('data-start', line.start); 
                    p.setAttribute('data-end', line.end); 
                    
                    p.className = `transcript-line speaker${line.speaker}`;
                    
                    // --- MODIFIED: Recommendation 3 (View Modes) ---
                    // Added <span class="german-text"> to individually hide German text
                    p.innerHTML = `<strong>Speaker ${line.speaker}:</strong> <span class="german-text">${line.text_de}</span>`;
                    transcriptContainer.appendChild(p);

                    // Create translation paragraph
                    const translation = document.createElement('p');
                    translation.className = 'translation';
                    translation.textContent = `[${line.text_en}]`;
                    transcriptContainer.appendChild(translation);
                });
                
                addJumpListeners();

            } catch (error) {
                transcriptContainer.innerHTML = `<p style="color: red;">Error loading transcript: ${error.message}</p>`;
            }
        }

        // Function to handle transcript highlighting and scrolling
        function syncTranscript(currentTime) {
            // --- NEW: Recommendation 4 (Loop Logic) ---
            if (isLooping && currentLineIndex !== -1) {
                const currentLine = transcriptData[currentLineIndex];
                if (currentTime >= currentLine.end || currentTime < currentLine.start) {
                    audioPlayer.currentTime = currentLine.start;
                    audioPlayer.play(); // Ensure it plays
                    return; // Stop sync logic to prevent highlight flicker
                }
            }
            
            const currentLine = transcriptData.find(line => 
                currentTime >= line.start && currentTime < line.end
            );
            
            let newIndex = currentLine ? transcriptData.indexOf(currentLine) : -1;

            if (newIndex !== currentLineIndex) {
                // Remove highlight from previous line
                if (currentLineIndex !== -1) {
                    const prevElement = document.querySelector(`.transcript-line[data-index="${currentLineIndex}"]`);
                    if (prevElement) prevElement.classList.remove('highlighted');
                }
                
                // Add highlight to new line
                if (newIndex !== -1) {
                    const newElement = document.querySelector(`.transcript-line[data-index="${newIndex}"]`);
                    if (newElement) {
                        newElement.classList.add('highlighted');
                        
                        // Scroll the container to keep the current line in view
                        if (!isLooping) { // Don't auto-scroll if looping one line
                            newElement.scrollIntoView({
                                behavior: 'smooth',
                                block: 'center'
                            });
                        }
                    }
                }
                currentLineIndex = newIndex;
            }
        }
        
        // Function to enable clicking on text to jump audio position
        function addJumpListeners() {
            document.querySelectorAll('.transcript-line').forEach(line => {
                line.addEventListener('click', function() {
                    const startTime = parseFloat(this.getAttribute('data-start'));
                    const audioPlayer = document.getElementById('audio-player');
                    audioPlayer.currentTime = startTime;
                    audioPlayer.play();
                });
                line.style.cursor = 'pointer';
            });
        }
        
        // --- NEW: Helper function to toggle translations ---
        function toggleTranslations() {
            const toggleBtn = document.getElementById('toggle-translation');
            const allTranslations = document.querySelectorAll('.translation');
            const isHidden = allTranslations.length > 0 && allTranslations[0].style.display === 'none';

            allTranslations.forEach(element => {
                element.style.display = isHidden ? 'block' : 'none';
            });
            
            toggleBtn.textContent = isHidden ? 'Hide Translations' : 'Show Translations';
        }


        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const lessonId = urlParams.get('lesson');

            // --- Get All Player Elements ---
            const audioPlayer = document.getElementById('audio-player');
            const customControls = document.getElementById('custom-controls');
            const audioLoader = document.getElementById('audio-loader');
            const playPauseBtn = document.getElementById('play-pause-btn');
            const iconPlay = document.getElementById('icon-play');
            const iconPause = document.getElementById('icon-pause');
            const currentTimeDisplay = document.getElementById('current-time-display');
            const totalTimeDisplay = document.getElementById('total-time-display');
            const progressBarWrapper = document.getElementById('progress-bar-wrapper');
            const progressBarFill = document.getElementById('progress-bar-fill');
            const speedSelector = document.getElementById('playback-speed');
            const transcriptContainer = document.getElementById('transcript-container');

            // --- Get New Control Elements ---
            const toggleBtn = document.getElementById('toggle-translation');
            const loopBtn = document.getElementById('loop-btn');
            const viewModeStandard = document.getElementById('view-mode-standard');
            const viewModeGerman = document.getElementById('view-mode-german');
            const viewModeEnglish = document.getElementById('view-mode-english');

            if (lessonId) {
                // --- Show loader, disable controls ---
                audioLoader.style.display = 'block';
                customControls.classList.add('is-loading');

                // --- 1. Load the Audio ---
                const audioSource = document.createElement('source');
                audioSource.src = `audio_${lessonId}.mp3`;
                audioSource.type = 'audio/mpeg';
                audioPlayer.appendChild(audioSource);
                
                // --- 2. Load and Display the Transcript from JSON ---
                loadTranscript(lessonId);

                // --- 3. Event Listeners for Custom Player ---
                audioPlayer.addEventListener('canplaythrough', () => {
                    audioLoader.style.display = 'none';
                    customControls.classList.remove('is-loading');
                    totalTimeDisplay.textContent = formatTime(audioPlayer.duration);
                });

                playPauseBtn.addEventListener('click', () => {
                    audioPlayer.paused ? audioPlayer.play() : audioPlayer.pause();
                });

                audioPlayer.addEventListener('play', () => {
                    iconPlay.style.display = 'none';
                    iconPause.style.display = 'block';
                });
                audioPlayer.addEventListener('pause', () => {
                    iconPlay.style.display = 'block';
                    iconPause.style.display = 'none';
                });

                // Update Progress Bar & Time & Transcript Sync
                audioPlayer.addEventListener('timeupdate', () => {
                    const progressPercent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                    progressBarFill.style.width = `${progressPercent}%`;
                    currentTimeDisplay.textContent = formatTime(audioPlayer.currentTime);
                    syncTranscript(audioPlayer.currentTime);
                });

                progressBarWrapper.addEventListener('click', (e) => {
                    const width = progressBarWrapper.clientWidth;
                    const clickX = e.offsetX;
                    const percent = clickX / width;
                    audioPlayer.currentTime = percent * audioPlayer.duration;
                });

                // --- 4. Listeners for New Controls ---
                
                // Toggle Translations Button
                toggleBtn.addEventListener('click', toggleTranslations);

                // --- NEW: Recommendation 4 (Loop Button) ---
                loopBtn.addEventListener('click', () => {
                    isLooping = !isLooping;
                    loopBtn.classList.toggle('active', isLooping);
                });

                // --- NEW: Recommendation 3 (View Modes) ---
                function setViewMode(mode) {
                    transcriptContainer.className = 'transcript-container ' + mode;
                    // Update active button state
                    viewModeStandard.classList.toggle('active', mode === 'view-standard');
                    viewModeGerman.classList.toggle('active', mode === 'view-german-only');
                    viewModeEnglish.classList.toggle('active', mode === 'view-english-only');
                }
                viewModeStandard.addEventListener('click', () => setViewMode('view-standard'));
                viewModeGerman.addEventListener('click', () => setViewMode('view-german-only'));
                viewModeEnglish.addEventListener('click', () => setViewMode('view-english-only'));

                // --- 5. Add listener for playback speed ---
                speedSelector.addEventListener('change', () => {
                    const newSpeed = parseFloat(speedSelector.value);
                    audioPlayer.playbackRate = newSpeed;
                });
                
                // --- NEW: Recommendation 2 (Keyboard Shortcuts) ---
                window.addEventListener('keydown', (e) => {
                    // Don't hijack shortcuts if user is typing in a text field (none exist, but good practice)
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

                    switch (e.key) {
                        case ' ': // Spacebar
                            e.preventDefault(); // Stop page from scrolling
                            playPauseBtn.click();
                            break;
                        case 'ArrowLeft':
                            audioPlayer.currentTime -= 5; // Rewind 5s
                            break;
                        case 'ArrowRight':
                            audioPlayer.currentTime += 5; // Forward 5s
                            break;
                        case 't':
                        case 'T':
                            toggleTranslations(); // Toggle translations
                            break;
                    }
                });

            } else {
                transcriptContainer.innerHTML = '<p>Error: No lesson selected.</p>';
                document.getElementById('player-wrapper').style.display = 'none';
                document.querySelector('.controls-bar').style.display = 'none';
            }
        });
    </script>

</body>
</html>